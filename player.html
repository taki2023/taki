<style>
*{box-sizing:border-box;}
html,body{margin:0;padding:0;width:100%;height:100%;background:transparent!important;overflow:hidden;}

/* PLAYER */
#playerBox{
  width:100%;
  padding:10px 12px;
  background:linear-gradient(180deg,rgba(18,12,10,.92),rgba(10,8,7,.95));
  border:2.5px solid rgba(255,176,120,.55);
  border-radius:16px;
  box-shadow:inset 0 0 14px rgba(0,0,0,.55),0 0 14px rgba(255,176,120,.22);
}

/* CONTROLS ROW */
#controlsRow{
  display:flex;
  align-items:center;
  gap:5px;
  margin-bottom:6px;
}

/* BUTTONS */
/* BUTTONS - smaller size */
#controlsRow button, #cutIcon{
  width:24px;   /* smaller */
  height:24px;  /* smaller */
  border-radius:50%;
  border:1px solid rgba(255,255,255,.15);
  background:rgba(255,255,255,.08);
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:15px; /* smaller icon size */
}


#playPauseBtn{
  background:linear-gradient(145deg,#ffb37a,#ff8a70);
  border:none;
  font-size:16px; /* keep slightly larger than others */
}

/* VOLUME BAR INLINE */
#volumeContainer{
  position:relative;
  display:flex;
  align-items:center;
  gap:6px;
}

#volumeBar{
  position:relative;
  width:55px;
  height:6px;
  background:linear-gradient(180deg,#1a120f,#120a08);
  border-radius:10px;
  border:1.8px solid rgba(255,176,120,.45);
  box-shadow:inset 0 0 8px rgba(0,0,0,.6),0 0 8px rgba(255,176,120,.15);
  cursor:pointer;
}

#volumeFill{
  height:100%;
  background:linear-gradient(90deg,#7b4dff,#9d6bff,#c59bff);
  border-radius:10px;
  width:70%; /* initial fill, JS will override */
}

#volumeKnob{
  position:absolute;
  top:50%;
  transform:translate(-50%, -50%);
  width:14px;
  height:14px;
  border-radius:50%;
  background:#e9ddff;
  left:70%; /* initial, JS will update */
  cursor:pointer;
  z-index:2;
}

/* PROGRESS BAR */
#progressBar{
  width:100%;
  height:8px;
  background:linear-gradient(180deg,#1a120f,#120a08);
  border-radius:10px;
  border:1.8px solid rgba(255,176,120,.45);
  box-shadow:inset 0 0 8px rgba(0,0,0,.6),0 0 8px rgba(255,176,120,.15);
  position:relative;
  cursor:pointer;
  margin-bottom:4px;
}

#progressFilled{
  height:100%;
  background:linear-gradient(90deg,#ffb37a,#ff8a70);
  border-radius:10px;
  width:0%;
  position:relative;
}

#progressKnob{
  position:absolute;
  top:50%;
  transform:translate(-50%, -50%);
  width:14px;
  height:14px;
  border-radius:50%;
  background:#ffd7b0;
  right:-7px; /* initial position */
  cursor:pointer;
  z-index:2;
}

/* TIME DISPLAY */
#timeDisplay{
  font-size:11px;
  font-family:Inter,Segoe UI,system-ui,sans-serif;
  color:#f1e7df;
  text-align:right;
  margin-bottom:6px;
}

/* SEARCH */
#searchInput{
  width:100%;
  padding:6px 8px;
  border-radius:8px;
  border:1px solid rgba(255,176,120,.4);
  background:rgba(0,0,0,.4);
  color:#fff;
  font-size:12px;
  margin-bottom:4px;
}

#searchResults{
  max-height:80px;
  overflow-y:auto;
  margin-bottom:6px;
}

/* PLAYLIST */
#playlistContainer{
  height:85px;
  overflow-y:auto;
  padding-right:4px;
  scrollbar-gutter: stable;
}

#playlistContainer::-webkit-scrollbar{
  width:6px;
}
#playlistContainer::-webkit-scrollbar-thumb{
  background:rgba(255,176,120,.6);
  border-radius:10px;
}
#playlistContainer::-webkit-scrollbar-track{
  background:transparent;
}

/* Playlist Items */
.playlistItem{
  cursor:pointer;
  padding:4px 8px;
  border-radius:6px;
  margin-bottom:2px;
  font-size:12px;
  font-family:Segoe UI,sans-serif;
  color:#f1e7df;
  background:rgba(255,176,120,0.05);
  transition: background .15s;
  user-select:none;
  display:flex;
  align-items:center;
  gap:8px;
}
.trackNumber{
  font-size:11px;
  opacity:0.6;
  letter-spacing:1px;
  min-width:22px;
}
.playlistItem:hover{
  background:rgba(255,176,120,0.15);
}
.playlistItem.active{
  background:rgba(255,176,120,0.3);
}
.dragging{
  opacity:0.5;
  background:rgba(255,176,120,0.2);
}

/* TOOLTIP */
.tooltip{
  position:fixed;
  background:#fff;
  color:#111;
  padding:2px 6px;
  border-radius:5px;
  font-size:11px;
  font-family:Segoe UI,sans-serif;
  box-shadow:0 2px 4px rgba(0,0,0,.25);
  pointer-events:none;
  opacity:0;
  transition:opacity .15s;
  z-index:9999;
  white-space:nowrap;
}
</style>

<div id="playerBox">
  <!-- CONTROLS ROW -->
  <div id="controlsRow">
    <button id="prevBtn">‚èÆ</button>
    <button id="playPauseBtn">‚ñ∂</button>
    <button id="nextBtn">‚è≠</button>
    <button id="loopBtn">üîÅ</button>
    <div id="volumeContainer">
      <span id="cutIcon">üîä</span>
      <div id="volumeBar">
        <div id="volumeFill"></div>
        <div id="volumeKnob"></div>
      </div>
    </div>
  </div>

  <!-- PROGRESS BAR -->
<div id="progressBar">
  <div id="progressFilled"></div>
  <div id="progressKnob"></div>
</div>


  <!-- TIME -->
  <div id="timeDisplay">0:00 / 0:00</div>

  <!-- SEARCH -->
  <input id="searchInput" type="text" placeholder="Search song...">
  <div id="searchResults"></div>

  <!-- PLAYLIST -->
  <div id="playlistContainer"></div>

  <!-- TOOLTIP -->
  <div id="tooltip" class="tooltip"></div>

  <audio id="audioPlayer"></audio>
</div>

<script src="songs-db.js"></script>

<script>
const audio = document.getElementById('audioPlayer');
const playBtn = document.getElementById('playPauseBtn');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const loopBtn = document.getElementById('loopBtn');
const cutIcon = document.getElementById('cutIcon');
const progressBar = document.getElementById('progressBar');
const progressFilled = document.getElementById('progressFilled');
const volumeBar = document.getElementById('volumeBar');
const volumeFill = document.getElementById('volumeFill');
const volumeKnob = document.getElementById('volumeKnob');
const timeDisplay = document.getElementById('timeDisplay');
const tooltip = document.getElementById('tooltip');
const playlistContainer = document.getElementById('playlistContainer');
const searchInput = document.getElementById('searchInput');
const searchResults = document.getElementById('searchResults');

/* ===== PLAYLIST WITH LOCAL STORAGE ===== */
let playlist = JSON.parse(localStorage.getItem('musicPlaylist')) || [
  { title: "Faded - Alan Walker", src: "https://cs1.mp3.pm/download/196179361/M0wyQ0lNU3lsSmcrcWVXSFZhSTFtTmZPTm9GL1VtLzMwNXNaZkpWU1FsTGdEcTNxcVFxVjd0dE1uM0dDdkx6Y0lxWk5tRDZqME5uR0NZa1NKeURsdTJZOTB1RVY3bFJlRWJ3UysyMXIvd0pvT21IY2doQ3UycWppcC9hYnc1Uzc/8D_TOP_MUSIC_-_Alan_Walker_-_Faded_(mp3.pm).mp3" },
  { title: "Luis Fonsi - Despacito", src: "https://cs1.mp3.pm/download/195259614/S3FXdExiZ3BHUVpFd3VISFpiaXJqVGExbExlYnhxb2lzOWNsajBidmxPUGd1V0dHb242a25Fd1pxc1JVY3lCa2xVa09IZ3BCcERSNktFdFRUS3JQMEhiVEZvNU1uZ1hxUmZzdlIranRWNjNQbzdrQjZQN09ndVhaSXo2ajFNVDE/Luis_Fonsi_-_Despacito_ft._Daddy_Yankee_-_Luis_Fonsi_-_Despacito_ft._Daddy_Yankee_(mp3.pm).mp3" },
  { title: "Sia - Unstoppable", src: "https://cs1.mp3.pm/download/194103041/UjM0Q3oydzJGNWhNbVpacXN1WGNCV2R5WDZITGVRQjN6MFZEMkt1bDlZdTJMbWxHbnpGVnlZdGhJSWZrYU54dnZ3UzJzUVFNU3M3M0pxbTA1ZTZKblNJWXlPc0ZyUUEyQmJacXhIUXYrMWhPVXRsekZ5Y2FiTDROTkZKUmdkekw/Sia_-_Im_unstoppable_today_(mp3.pm).mp3"},
  { title: "Imagine Dragons - Believer", src: "https://cs1.mp3.pm/download/218683216/UjM0Q3oydzJGNWhNbVpacXN1WGNCV2R5WDZITGVRQjN6MFZEMkt1bDlZdFJmUjdYN1VOZzhVeGdJcUhXSXlSdUlYdEc4OFFvMzNxWXpCaFdxNzA5OXJyWnBycnhnZHhaS2lBNkNLTnJseERtWHhMTUZocmFRSHhKdzNsOHh5Wks/Imagine_Dragons_-_Believer_NPBM2020_(mp3.pm).mp3"}
];


let currentTrack = parseInt(localStorage.getItem('musicCurrentTrack')) || 0;
let savedTime = parseFloat(localStorage.getItem('musicTime')) || 0;

function loadTrack(index) {
  if (!playlist.length) return; // safety if playlist empty

  currentTrack = index;
  audio.src = playlist[index].src;

audio.onloadedmetadata = () => {
  if (savedTime > 0 && savedTime < audio.duration) {
    audio.currentTime = savedTime;
  } else {
    audio.currentTime = 0;
  }

  // Immediately update progress UI to match savedTime
  const p = (audio.currentTime / audio.duration) * 100;
  progressFilled.style.width = p + '%';
  progressKnob.style.left = p + '%';
  timeDisplay.textContent = fmt(audio.currentTime) + ' / ' + fmt(audio.duration);
};


  updatePlaylistUI();
  savePlaylistState();
}

function updatePlaylistUI(){
  playlistContainer.innerHTML = '';
  if (playlist.length === 0) {
    playlistContainer.innerHTML = `
      <div style="
        text-align:center;
        font-size:11px;
        opacity:0.5;
        padding-top:20px;
        color:#f1e7df;
      ">
        No songs in playlist
      </div>
    `;
    return; // VERY IMPORTANT
  }
  playlist.forEach((track,i)=>{
    const div = document.createElement('div');
    div.innerHTML = `
  <span class="trackNumber">${String(i+1).padStart(2,'0')}</span>
  <span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">
    ${track.title}
  </span>
  <span class="removeBtn" style="
    cursor:pointer;
    padding:0 6px;
    font-size:12px;
    opacity:0.7;
  ">‚úñ</span>
`;
    div.className = 'playlistItem' + (i===currentTrack?' active':'');
    div.setAttribute('draggable','true');

    // click to play
    div.onclick = ()=> { savedTime = 0; loadTrack(i); };
// remove button
function deleteTrack(index) {
  // Remove the song
  playlist.splice(index, 1);

  // If playlist is empty
  if (playlist.length === 0) {
    audio.pause();
    audio.src = "";
    currentTrack = 0;
    savedTime = 0;
    updatePlaylistUI();
    savePlaylistState();
    playBtn.textContent = "‚ñ∂"; // reset play button
    return;
  }

  // If deleted track was before current track
  if (index < currentTrack) {
    currentTrack--;
  }

  // If deleted track was the current one
  if (index === currentTrack) {
    // reset audio but do NOT autoplay
    audio.pause();
    savedTime = 0;
    if (currentTrack >= playlist.length) {
      currentTrack = playlist.length - 1;
    }
    loadTrack(currentTrack);
    playBtn.textContent = "‚ñ∂"; // ensure play button shows play
  }

  updatePlaylistUI();
  savePlaylistState();
}


const removeBtn = div.querySelector('.removeBtn');
removeBtn.onclick = (e) => {
  e.stopPropagation(); // prevent playing when clicking remove
  deleteTrack(i);      // call the safe delete function
};


    // drag events
    div.addEventListener('dragstart', (e)=>{
      div.classList.add('dragging');
      e.dataTransfer.effectAllowed = "move";
      e.dataTransfer.setData("text/plain", i);
    });
    div.addEventListener('dragend', ()=>{
      div.classList.remove('dragging');
      reorderPlaylist();
    });
    div.addEventListener('dragover', (e)=>{
      e.preventDefault();
    });
    div.addEventListener('drop', (e)=>{
      e.preventDefault();
      const fromIndex = parseInt(e.dataTransfer.getData("text/plain"));
      const toIndex = Array.from(playlistContainer.children).indexOf(div);
      if(fromIndex !== toIndex){
        const item = playlist.splice(fromIndex,1)[0];
        playlist.splice(toIndex,0,item);
        if(currentTrack === fromIndex) currentTrack = toIndex;
        else if(fromIndex < currentTrack && toIndex >= currentTrack) currentTrack--;
        else if(fromIndex > currentTrack && toIndex <= currentTrack) currentTrack++;
        updatePlaylistUI();
        savePlaylistState();
      }
    });

    playlistContainer.appendChild(div);
  });
}

function reorderPlaylist(){ updatePlaylistUI(); savePlaylistState(); }
function savePlaylistState(){
  localStorage.setItem('musicPlaylist', JSON.stringify(playlist));
  localStorage.setItem('musicCurrentTrack', currentTrack);
}

/* ===== AUTO PLAY NEXT ===== */
audio.onended = () => { nextTrack(); }

/* ===== NAVIGATION ===== */
function prevTrack(){
  if (!playlist.length) return;
  savedTime = 0;
  currentTrack--;
  if(currentTrack < 0) currentTrack = playlist.length -1;
  loadTrack(currentTrack);
}
function nextTrack(){
  if (!playlist.length) return;
  savedTime = 0;
  currentTrack++;
  if(currentTrack >= playlist.length) currentTrack = 0;
  loadTrack(currentTrack);
}

prevBtn.onclick = prevTrack;
nextBtn.onclick = nextTrack;


/* ===== SEARCH SYSTEM ===== */
function renderSearchResults(list) {
  searchResults.innerHTML = '';

  list.forEach(song => {

    const exists = playlist.some(p => p.src === song.src);

    const div = document.createElement('div');

    div.innerHTML = `
      <span style="
        flex:1;
        overflow:hidden;
        text-overflow:ellipsis;
        white-space:nowrap;
      ">
        ${song.title}
      </span>
      <span class="addBadge" style="
        font-size:11px;
        padding:2px 6px;
        border-radius:6px;
        background:${exists ? 'rgba(120,255,170,0.25)' : 'rgba(255,176,120,0.25)'};
        color:${exists ? '#7cffb0' : '#ffb37a'};
      ">
        ${exists ? '‚úì Added' : '+ Add'}
      </span>
    `;

    div.style.cssText = `
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      padding:5px 6px;
      font-size:12px;
      cursor:${exists ? 'default' : 'pointer'};
      border-radius:6px;
      margin-bottom:2px;
      background:rgba(255,176,120,0.08);
      color:#f1e7df;
      transition:all .35s ease;
    `;

    if (!exists) {
      div.onmouseenter = () => {
        div.style.background = 'rgba(255,176,120,0.18)';
      };

      div.onmouseleave = () => {
        div.style.background = 'rgba(255,176,120,0.08)';
      };

div.onclick = () => {
  const wasEmpty = playlist.length === 0;

  playlist.push(song);
  savePlaylistState();
  updatePlaylistUI();

  // üéâ Soft click animation (no green stay)
  div.style.transform = "scale(0.97)";
  div.style.opacity = "0.7";

  setTimeout(() => {
    div.style.transform = "scale(1)";
    div.style.opacity = "1";
    div.style.background = "rgba(255,176,120,0.08)"; // restore original
  }, 150);

  // ‚úÖ Update badge only
  const badge = div.querySelector(".addBadge");
  badge.textContent = "‚úì Added";
  badge.style.background = "rgba(120,255,170,0.25)";
  badge.style.color = "#7cffb0";

  div.style.cursor = "default";
  div.onmouseenter = null;
  div.onmouseleave = null;
  div.onclick = null;

  if (wasEmpty) {
    currentTrack = 0;
    savedTime = 0;
    loadTrack(currentTrack);
  }
};

    }

    searchResults.appendChild(div);
  });
}

searchInput.addEventListener('focus', function() {
  renderSearchResults(songDatabase);
});
searchInput.addEventListener('input', function() {
  const query = this.value.toLowerCase().trim();

  if (!query) {
    renderSearchResults(songDatabase);
    return;
  }

  const filtered = songDatabase.filter(song =>
    song.title.toLowerCase().includes(query)
  );

  renderSearchResults(filtered);
});
const playerBox = document.getElementById('playerBox');

function hideSearchResults() {
  searchResults.innerHTML = '';
}


// Close search results when clicking anywhere inside the player BUT outside input/results
playerBox.addEventListener("click", function(e) {
  if (!e.target.closest("#searchInput") && !e.target.closest("#searchResults")) {
    searchResults.innerHTML = '';
  }
});

document.addEventListener("click", function(e) {
  if (!e.target.closest("#searchInput") &&
      !e.target.closest("#searchResults")) {
    hideSearchResults();
  }
}, true);

/* ===== INITIAL LOAD ===== */
if (playlist.length > 0) {
  loadTrack(currentTrack);
} else {
  updatePlaylistUI();  // show "No songs in playlist"
}

/* ===== VOLUME / PLAY / LOOP / TIME / SEEK ===== */
const savedVolume = localStorage.getItem('musicVolume');
const savedMuted = localStorage.getItem('musicMuted') === 'true';
const savedLoop = localStorage.getItem('musicLoop') === 'true';
const savedPlaying = localStorage.getItem('musicPlaying') === 'true';

audio.volume = savedVolume !== null ? parseFloat(savedVolume) : 0.7;
audio.muted = savedMuted;
audio.loop = savedLoop;

function syncVolumeUI(){
  const v = audio.muted ? 0 : audio.volume;
  volumeFill.style.width = (v*100)+'%';
  volumeKnob.style.left = (v*100)+'%';
  cutIcon.textContent = audio.muted || v===0 ? 'üîá' : 'üîä';
}
syncVolumeUI();

function fmt(s){
  const m=Math.floor(s/60);
  const sec=Math.floor(s%60);
  return m+':'+(sec<10?'0':'')+sec;
}

audio.ontimeupdate = () => {
  const p = (audio.currentTime / (audio.duration || 1)) * 100;
  progressFilled.style.width = p + '%';   // update the fill
  progressKnob.style.left = p + '%';      // update the knob
  timeDisplay.textContent = fmt(audio.currentTime) + ' / ' + fmt(audio.duration || 0);
  localStorage.setItem('musicTime', audio.currentTime);
};

function seek(e){
  if (!audio.duration || isNaN(audio.duration)) return;

  const r = progressBar.getBoundingClientRect();
  const x = (e.touches ? e.touches[0].clientX : e.clientX) - r.left;
  const percent = Math.max(0, Math.min(1, x / r.width));

  audio.currentTime = percent * audio.duration;
}

// drag progress bar
progressBar.onmousedown = e => { 
  seek(e); 
  document.onmousemove = seek; 
  document.onmouseup = () => document.onmousemove = null; 
};
progressBar.ontouchstart = seek; 
progressBar.ontouchmove = seek;

// drag knob directly
progressKnob.onmousedown = e => {
  e.stopPropagation();
  document.onmousemove = seek;
  document.onmouseup = () => document.onmousemove = null;
};
progressKnob.ontouchstart = e => {
  e.stopPropagation();
  document.ontouchmove = seek;
};
progressKnob.ontouchend = () => { document.ontouchmove = null; };


function setVolume(v){
  v=Math.max(0,Math.min(1,v));
  audio.volume=v;
  audio.muted=false;
  localStorage.setItem('musicVolume',v);
  localStorage.setItem('musicMuted',false);
  syncVolumeUI();
}
function volFromEvent(e){
  const r=volumeBar.getBoundingClientRect();
  const x=(e.touches?e.touches[0].clientX:e.clientX)-r.left;
  setVolume(x/r.width);
}
volumeBar.onmousedown=e=>{ volFromEvent(e); document.onmousemove=volFromEvent; document.onmouseup=()=>document.onmousemove=null; };
volumeBar.ontouchstart=volFromEvent; volumeBar.ontouchmove=volFromEvent;

cutIcon.onclick=()=>{ audio.muted=!audio.muted; localStorage.setItem('musicMuted',audio.muted); syncVolumeUI(); };

playBtn.onclick = ()=>{
  if(audio.paused){ audio.play(); } else { audio.pause(); }
};
audio.onplay = ()=>{ playBtn.textContent='‚ùö‚ùö'; localStorage.setItem('musicPlaying',true); };
audio.onpause = ()=>{ playBtn.textContent='‚ñ∂'; localStorage.setItem('musicPlaying',false); };

/* ===== LOOP ===== */
loopBtn.onclick = ()=> {
  audio.loop = !audio.loop;
  localStorage.setItem('musicLoop',audio.loop);
  loopBtn.style.background = audio.loop ? 'linear-gradient(145deg,#ffb37a,#ff8a70)' : 'rgba(255,255,255,.08)';
};
loopBtn.style.background = audio.loop ? 'linear-gradient(145deg,#ffb37a,#ff8a70)' : 'rgba(255,255,255,.08)';

/* ===== TOOLTIP ===== */
function showTooltipAtElement(el, text){
  tooltip.textContent = text;
  const rect = el.getBoundingClientRect();
  const tooltipWidth = tooltip.offsetWidth;
  const tooltipHeight = tooltip.offsetHeight;

  let top = rect.top - tooltipHeight - 6;
  let left = rect.left + rect.width/2 - tooltipWidth/2;

  if(top < 4) top = rect.bottom + 6;
  if(left < 4) left = 4;
  if(left + tooltipWidth > window.innerWidth - 4) left = window.innerWidth - tooltipWidth - 4;

  tooltip.style.left = left + 'px';
  tooltip.style.top = top + 'px';
  tooltip.style.opacity = 1;
}
function hideTooltip(){ tooltip.style.opacity = 0; }
function attachTooltip(el, getText){
  el.onmouseenter = ()=> showTooltipAtElement(el,getText());
  el.onmouseleave = hideTooltip;
}
attachTooltip(playBtn, ()=> audio.paused ? 'Play' : 'Pause');
attachTooltip(loopBtn, ()=> 'Loop');
attachTooltip(cutIcon, ()=> audio.muted ? 'Unmute' : 'Mute');
attachTooltip(prevBtn, ()=> 'Previous Track');
attachTooltip(nextBtn, ()=> 'Next Track');

</script>
