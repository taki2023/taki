<div id="welcomeBox">Loading...</div>

<script>
const club = "hot-chilli-checkmate";
const storageKey = "clubMembers";

// Example serverless CORS-friendly API endpoint
const corsProxy = "https://api.allorigins.win/get?url="; 

async function fetchMembers() {
  try {
    const url = encodeURIComponent(`https://api.chess.com/pub/club/${club}/members`);
    const res = await fetch(corsProxy + url);
    const textData = await res.json();

    // allorigins wraps the response in a contents field
    const data = JSON.parse(textData.contents);

    if (!data.all_time || !Array.isArray(data.all_time)) throw new Error("Unexpected API format");

    // Sort by joined timestamp (newest first)
    return data.all_time.sort((a, b) => b.joined - a.joined);

  } catch (err) {
    console.error("Fetch error:", err);
    return null;
  }
}

async function checkForNewMember() {
  const currentList = await fetchMembers();
  if (!currentList) {
    document.getElementById("welcomeBox").innerHTML = "Error fetching members.";
    return;
  }

  const savedData = JSON.parse(localStorage.getItem(storageKey)) || [];
  const savedUsernames = savedData.map(m => m.username);

  const newest = currentList.find(m => !savedUsernames.includes(m.username));

  if (newest) {
    document.getElementById("welcomeBox").innerHTML =
      `ðŸŽ‰ NEW RECRUIT!<br><b>${newest.username}</b> joined the Chillies Army ðŸ”¥`;
    localStorage.setItem(storageKey, JSON.stringify(currentList));
  } else {
    document.getElementById("welcomeBox").innerHTML = "No new members yet.";
  }
}

// Run immediately
checkForNewMember();

// Repeat every 2 minutes
setInterval(checkForNewMember, 1200);
</script>
