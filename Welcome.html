<div id="welcomeBox">Loading...</div>

<script>
const club = "hot-chilli-checkmate";
const proxy = "https://corsproxy.io/?";
const storageKey = "clubMembers";

async function fetchMembers() {
  try {
    const res = await fetch(
      proxy + encodeURIComponent(`https://api.chess.com/pub/club/${club}/members`)
    );
    const data = await res.json();

    if (!data.all_time || !Array.isArray(data.all_time)) {
      throw new Error("Unexpected API response");
    }

    // Sort by joined timestamp descending
    const sorted = data.all_time.sort((a, b) => b.joined - a.joined);
    return sorted;

  } catch (err) {
    console.error("Fetch error:", err);
    return null;
  }
}

async function checkForNewMember() {
  const currentList = await fetchMembers();
  if (!currentList) {
    document.getElementById("welcomeBox").innerHTML = "Error fetching members.";
    return;
  }

  const savedData = JSON.parse(localStorage.getItem(storageKey));

  if (!savedData) {
    localStorage.setItem(storageKey, JSON.stringify(currentList));
    document.getElementById("welcomeBox").innerHTML = "Tracking new members...";
    return;
  }

  const savedUsernames = savedData.map(m => m.username);
  const newest = currentList.find(m => !savedUsernames.includes(m.username));

  if (newest) {
    document.getElementById("welcomeBox").innerHTML =
      `ðŸŽ‰ NEW RECRUIT!<br><b>${newest.username}</b> joined the Chillies Army ðŸ”¥`;
    localStorage.setItem(storageKey, JSON.stringify(currentList));
  } else {
    document.getElementById("welcomeBox").innerHTML = "No new members yet.";
  }
}

// Run immediately
checkForNewMember();

// Check every 2 minutes
setInterval(checkForNewMember, 120000);
</script>
